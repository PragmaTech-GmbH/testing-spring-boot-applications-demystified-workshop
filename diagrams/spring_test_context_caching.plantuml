@startuml Spring Test Context Caching

!define CACHE_COLOR #E1F5FE
!define HIT_COLOR #A5D6A7
!define MISS_COLOR #FFAB91
!define CONTEXT_COLOR #BBDEFB
!define DIRTY_COLOR #FFCCBC

skinparam rectangle {
    BackgroundColor white
    BorderColor #455A64
    FontColor #000000
}

rectangle "Spring Test Context Caching" {
    rectangle "Context Cache" as Cache #CACHE_COLOR {
        rectangle "Context 1\n[@SpringBootTest(properties = 'a=1')]" as Context1 #CONTEXT_COLOR
        rectangle "Context 2\n[@SpringBootTest(properties = 'a=2')]" as Context2 #CONTEXT_COLOR
        rectangle "Context 3\n[@WebMvcTest(BookController.class)]" as Context3 #CONTEXT_COLOR
    }
    
    rectangle "Test Execution" {
        rectangle "Test A\n[@SpringBootTest(properties = 'a=1')]" as TestA
        rectangle "Test B\n[@SpringBootTest(properties = 'a=1')]" as TestB
        rectangle "Test C\n[@SpringBootTest(properties = 'a=2')]" as TestC
        rectangle "Test D\n[@SpringBootTest(properties = 'a=1')]\n[@DirtiesContext]" as TestD
    }
    
    TestA -right-> Context1: "1. Cache Miss\nCreate context" #MISS_COLOR
    TestB -right-> Context1: "2. Cache Hit\nReuse context" #HIT_COLOR
    TestC -right-> Context2: "3. Cache Miss\nCreate context" #MISS_COLOR
    TestD -right-> Context1: "4. Cache Hit\nReuse context" #HIT_COLOR
    TestD -[#FF5252]-> Context1: "5. Mark as dirty\nWill be evicted" #DIRTY_COLOR
}

note bottom of TestA
  First test with these properties.
  Context is created and cached.
end note

note bottom of TestB
  Same context configuration as Test A.
  Reuses the cached context.
end note

note bottom of TestC
  Different property value.
  New context is created and cached.
end note

note bottom of TestD
  Same configuration as Test A and B, but
  @DirtiesContext marks the context as dirty.
  It will be evicted from the cache after this test.
end note

note bottom of Cache
  Context Caching Key Factors:
  - Configuration annotations (@SpringBootTest, @WebMvcTest, etc.)
  - Configuration properties
  - Context customizers
  - Active profiles
  - Property sources
  - Test class ContextLoader
end note

@enduml